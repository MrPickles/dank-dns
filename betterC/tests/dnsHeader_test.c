#include "test.h"

#include <stdlib.h>

#include "dns.h"

int main() {
  print_section("DNS Header Test");
  print_state("Empty packets should fail", parseDNS(NULL, NULL, 0) == -1);

  unsigned char payload1[] = {
    0x82, 0x1e, 0x86, 0x03, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x06, 0x61, 0x31, 0x37,
    0x2d, 0x30, 0x37, 0x03, 0x72, 0x73, 0x77, 0x03,
    0x6b, 0x72, 0x32, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x00, 0x29, 0x10, 0x00, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00
  };
  dns_t dns = {0};
  parseDNS(&dns, payload1, sizeof(payload1));

  print_state("Header 1 ID Check", dns.header.id == 0x821e);
  print_state("Header 1 Flag Check",
      dns.header.flags1 == 0x86 && dns.header.flags2 == 0x03);
  print_state("Header 1 Question Count", dns.header.qdcount == 1);
  print_state("Header 1 Answer Count", dns.header.ancount == 0);
  print_state("Header 1 Authority Count", dns.header.nscount == 0);
  print_state("Header 1 Additional Count", dns.header.arcount == 1);

  unsigned char dnsQuery[] = {
    0x82, 0x1e, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x06, 0x61, 0x31, 0x37,
    0x2d, 0x30, 0x37, 0x03, 0x72, 0x73, 0x77, 0x03,
    0x6b, 0x72, 0x32, 0x00, 0x00, 0x01, 0x00, 0x01,
    0x00, 0x00, 0x29, 0x02, 0x00, 0x00, 0x00, 0x80,
    0x00, 0x00, 0x00
  };
  print_state("Parsing should ignore DNS query packets",
      parseDNS(&dns, dnsQuery, sizeof(dnsQuery)) == -1);

  return 0;
}

